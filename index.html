<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Email Assistant â€“ Inâ€‘Page Chat</title>
  <style>
    :root{
      --bg:#0b0f14;           /* page background */
      --panel:#121820;        /* cards/panels */
      --muted:#202938;        /* borders/lines */
      --text:#e8eef6;         /* main text */
      --sub:#93a1b5;          /* secondary */
      --me:#2c7be5;           /* user bubble */
      --assistant:#8b5cf6;    /* assistant bubble */
      --err:#ff5a6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #0b0f14 0%, #0b0f14 60%, #0d1420 100%);
      color:var(--text);
      font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .app{
      height:100%;
      display:flex; flex-direction:column; gap:12px;
      max-width:880px; margin:0 auto; padding:18px 16px 22px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:var(--panel); border:1px solid var(--muted);
      border-radius:14px;
      position:sticky; top:12px; z-index:3;
      backdrop-filter: blur(6px);
    }
    header h1{font-size:16px; margin:0; letter-spacing:.2px}
    header .pill{
      font-size:12px; color:var(--sub); background:#0f1520; border:1px solid var(--muted);
      padding:6px 10px; border-radius:999px;
    }
    #statusBar{font-size:12px; color:var(--sub)}

    .chat{
      flex:1; min-height:0;
      background:var(--panel); border:1px solid var(--muted); border-radius:16px;
      padding:14px; display:flex; flex-direction:column; gap:12px;
      overflow:auto; scroll-behavior:smooth;
    }
    .msg{
      display:flex; gap:10px; align-items:flex-end; max-width:78%;
      animation:fade .2s ease-in;
    }
    .msg.right{margin-left:auto; justify-content:flex-end}
    .avatar{width:28px; height:28px; border-radius:50%; flex:0 0 28px; background:#1a2232; display:flex; align-items:center; justify-content:center; color:#c9d6ea; font-size:12px; border:1px solid var(--muted)}
    .bubble{
      padding:10px 12px; border-radius:14px; word-wrap:break-word; white-space:pre-wrap;
      border:1px solid transparent;
    }
    .me .bubble{ background:rgba(44,123,229,.18); border-color:#244a7b }
    .assistant .bubble{ background:rgba(139,92,246,.18); border-color:#3b2a69 }
    .meta{ font-size:11px; color:var(--sub); margin-top:4px }

    @keyframes fade{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }

    .composer{
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end;
      background:var(--panel); border:1px solid var(--muted); border-radius:16px; padding:12px;
      position:sticky; bottom:0; z-index:3;
    }
    textarea{
      width:100%; resize:none; min-height:54px; max-height:180px; padding:12px 12px 10px 12px;
      border-radius:12px; border:1px solid var(--muted); background:#0f1520; color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      outline:none;
    }
    textarea:focus{ border-color:#2c7be5 }
    button{
      height:40px; padding:0 16px; border-radius:12px; border:1px solid var(--muted);
      background:#182238; color:#e9effb; cursor:pointer; font-weight:600;
    }
    button:disabled{ opacity:.6; cursor:not-allowed }

    .hint{ color:var(--sub); font-size:12px; text-align:center }
    .error{ color:var(--err) }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>AI Email Assistant</h1>
      <div>
        <span id="statusBar">Ready</span>
        <span class="pill" id="threadPill">thread: â€“</span>
      </div>
    </header>

    <main class="chat" id="chat" aria-live="polite"></main>

    <form class="composer" id="composerForm">
      <textarea id="composer" placeholder="Type a message for the AIâ€¦ (Shift+Enter = newline)" spellcheck="true"></textarea>
      <button id="sendBtn" type="submit">Send</button>
    </form>

    <div class="hint">Replies are fetched from <code>/.netlify/functions/list-thread</code>. Make sure your Netlify functions are deployed.</div>
  </div>

  <script>
    // === Config ===
    const INBOUND_TO = "stage03@c7odemo1.zendesk.com"; // AI email assistant
    const SUBJECT = "Demo Assistant Conversation";

    // === State ===
    let threadId = loadThreadId();
    let polling = false;
    let lastRenderedIds = new Set();

    const chat = document.getElementById('chat');
    const statusBar = document.getElementById('statusBar');
    const threadPill = document.getElementById('threadPill');
    const form = document.getElementById('composerForm');
    const input = document.getElementById('composer');
    const sendBtn = document.getElementById('sendBtn');

    updateThreadPill();

    // Auto-start polling this thread
    startPolling();

    // === Handlers ===
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (input.value || '').trim();
      if (!text) return;

      try {
        setSending(true);
        // optimistic UI
        appendMessage({ id: 'local-' + Date.now(), from: 'You', text, date: new Date().toISOString() }, true);

        // Send email via Netlify function with custom header for threading
        await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: INBOUND_TO,
            subject: SUBJECT,
            body: text,
            threadId,
            headers: { 'X-Thread-Id': threadId } // ðŸ‘ˆ custom header passed to serverless
          })
        });

        input.value = '';
        input.focus();
        // Ensure polling is running
        startPolling();
      } catch (err) {
        console.error(err);
        showStatus('Send failed', true);
      } finally {
        setSending(false);
      }
    });

    // Shift+Enter for newline, Enter to send
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // === Polling ===
    function startPolling(){
      if (polling) return; // already running
      polling = true;
      pollOnce();
    }

    async function pollOnce(){
      try {
        const res = await fetch('/.netlify/functions/list-thread?thread=' + encodeURIComponent(threadId), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const messages = await res.json();
        renderThread(messages);
      } catch (e) {
        console.warn('Polling error:', e);
        showStatus('Waiting for repliesâ€¦');
      } finally {
        setTimeout(pollOnce, 4000); // every 4s
      }
    }

    // === Rendering ===
    function renderThread(list){
      if (!Array.isArray(list)) return;
      // sort by date ascending
      list.sort((a,b)=> new Date(a.date||0) - new Date(b.date||0));
      for (const m of list){
        if (lastRenderedIds.has(m.id)) continue;
        appendMessage(m, false);
      }
      showStatus(list.length ? 'Synced' : 'No messages yet');
    }

    function appendMessage(m, optimistic){
      lastRenderedIds.add(m.id);
      const isAssistant = looksLikeAssistant(m.from);
      const side = isAssistant ? 'left' : 'right';

      const row = document.createElement('div');
      row.className = 'msg ' + (isAssistant ? '' : 'right') + ' ' + (isAssistant ? 'assistant' : 'me');

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = isAssistant ? 'AI' : 'You';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = (m.text || '').trim();

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = labelFrom(m.from) + ' â€¢ ' + fmtTime(m.date);

      const col = document.createElement('div');
      col.style.maxWidth = '100%';
      col.appendChild(bubble);
      col.appendChild(meta);

      if (isAssistant){
        row.appendChild(avatar);
        row.appendChild(col);
      } else {
        row.appendChild(col);
        row.appendChild(avatar);
      }

      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    // === Helpers ===
    function looksLikeAssistant(from=''){
      const s = String(from).toLowerCase();
      return /zendesk\.com|stage\d+@c7odemo1\.zendesk\.com|\bassistant\b/.test(s);
    }
    function labelFrom(from=''){
      if (!from) return 'Unknown';
      const s = String(from);
      if (looksLikeAssistant(s)) return 'Assistant';
      if (/you\b/i.test(s)) return 'You';
      return s.replace(/<.*?>/g,'').trim();
    }
    function fmtTime(d){
      try{
        const dt = d ? new Date(d) : new Date();
        return dt.toLocaleString();
      }catch{ return '' }
    }
    function setSending(on){
      sendBtn.disabled = on; input.disabled = on;
      showStatus(on ? 'Sendingâ€¦' : 'Ready');
    }
    function showStatus(msg, isErr){
      statusBar.textContent = msg; statusBar.className = isErr? 'error':'';
    }
    function loadThreadId(){
      const saved = localStorage.getItem('ai_mail_thread');
      if (saved) return saved;
      const t = generateThreadId();
      localStorage.setItem('ai_mail_thread', t);
      return t;
    }
    function updateThreadPill(){ threadPill.textContent = 'thread: ' + threadId }
    function generateThreadId(){ return 't-' + Date.now() + '-' + Math.random().toString(36).slice(2,8) }
  </script>
</body>
</html>